"use strict";(globalThis["webpackChunkcom_kinago_single"]=globalThis["webpackChunkcom_kinago_single"]||[]).push([[4584],{4584:(e,t,s)=>{s.r(t),s.d(t,{default:()=>re});var i=s(1758),a=s(8790);const r={class:"row justify-center q-pa-md"},o={class:"col-md-9 col-12"},l={class:"row"},n={key:0,class:"col-md-4 col-sm-4 col-xs-12"},d={class:"col-md-8 col-sm-8 col-xs-12"},c={class:"text-weight-bold no-margin"},u={key:0,class:"text-weight-bold"},h={key:0,class:"text-caption text-grey"},g=["src"],m={class:"q-pa-md flex items-stretch content-end",style:{"min-height":"calc(60vh)"}},p={key:0},_={key:0,class:"bg-white text-dark q-pl-sm q-pr-sm border-grey full-width"},f={class:"flex justify-start q-col-gutter-x-md"},y=["src"],b={class:"absolute-right",style:{"margin-right":"-10px","margin-top":"-5px"}},k={key:0,class:"q-gutter-sm"},v={key:0,class:"q-pa-sm"},x={class:"row"},F={class:"col-6 q-gutter-sm"},C={class:"col text-right"};function D(e,t,s,D,U,q){const A=(0,i.g2)("StickyBack"),$=(0,i.g2)("LocationNav"),E=(0,i.g2)("AccountNav"),w=(0,i.g2)("q-btn"),Q=(0,i.g2)("q-item-section"),I=(0,i.g2)("q-avatar"),S=(0,i.g2)("q-item"),X=(0,i.g2)("q-separator"),j=(0,i.g2)("q-inner-loading"),T=(0,i.g2)("q-img"),M=(0,i.g2)("q-chat-message"),L=(0,i.g2)("q-spinner-dots"),P=(0,i.g2)("q-scroll-area"),O=(0,i.g2)("q-uploader-add-trigger"),W=(0,i.g2)("q-uploader"),z=(0,i.g2)("q-icon"),R=(0,i.g2)("EmojiPicker"),V=(0,i.g2)("q-card"),B=(0,i.g2)("q-popup-proxy"),H=(0,i.g2)("q-input"),K=(0,i.g2)("q-page");return(0,i.uX)(),(0,i.Wv)(K,{padding:""},{default:(0,i.k6)((()=>[q.isMobile?((0,i.uX)(),(0,i.Wv)(A,{key:0,url:"/account/menu",label:"Back"})):((0,i.uX)(),(0,i.Wv)($,{key:1})),(0,i.Lk)("div",r,[(0,i.Lk)("div",o,[(0,i.Lk)("div",l,[q.isMobile?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("div",n,[(0,i.bF)(E)])),(0,i.Lk)("div",d,[(0,i.bF)(V,{flat:"",class:"fit"},{default:(0,i.k6)((()=>[(0,i.bF)(S,null,{default:(0,i.k6)((()=>[q.isMobile?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.Wv)(Q,{key:0,avatar:""},{default:(0,i.k6)((()=>[q.isMobile?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.Wv)(w,{key:0,dense:"",flat:"",color:"dark",icon:"arrow_back_ios",to:"/account/chat","no-caps":"",label:e.$t("Back"),class:"no-margin"},null,8,["label"]))])),_:1})),(0,i.bF)(Q,null,{default:(0,i.k6)((()=>[(0,i.Lk)("h5",c,[q.getUserData[U.participant_user_uuid]?((0,i.uX)(),(0,i.CE)("div",u,(0,a.v_)(q.getUserData[U.participant_user_uuid].first_name)+" "+(0,a.v_)(q.getUserData[U.participant_user_uuid].last_name),1)):(0,i.Q3)("",!0)]),U.order_id?((0,i.uX)(),(0,i.CE)("div",h,(0,a.v_)(e.$t("Order#"))+" "+(0,a.v_)(U.order_id),1)):(0,i.Q3)("",!0)])),_:1}),(0,i.bF)(Q,{side:""},{default:(0,i.k6)((()=>[(0,i.bF)(I,{size:"40px"},{default:(0,i.k6)((()=>[q.getUserData[U.participant_user_uuid]?((0,i.uX)(),(0,i.CE)("img",{key:0,src:q.getUserData[U.participant_user_uuid].photo_url},null,8,g)):(0,i.Q3)("",!0)])),_:1})])),_:1})])),_:1}),(0,i.bF)(X),(0,i.Lk)("div",m,[(0,i.bF)(P,{style:{height:"calc(50vh)",width:"100%"},class:"q-pb-md",visible:!0,ref:"scroll_ref"},{default:(0,i.k6)((()=>[(0,i.bF)(j,{showing:U.loading,color:"primary",label:e.$t("Please wait..."),"label-class":"text-dark","label-style":"font-size: 1em"},null,8,["showing","label"]),((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(q.getChatmessage,(t=>((0,i.uX)(),(0,i.Wv)(M,{key:t,name:q.getUserData[t.senderID]?t.senderID==U.user_uuid?e.$t("You"):q.getUserData[t.senderID].first_name:"",avatar:q.getUserData[t.senderID]?q.getUserData[t.senderID].photo_url:"",stamp:t.time,"text-color":t.senderID==U.user_uuid?"white":"dark","bg-color":t.senderID==U.user_uuid?"blue":"grey-2",sent:t.senderID==U.user_uuid},{avatar:(0,i.k6)((()=>[(0,i.bF)(I,{class:"q-ml-sm"},{default:(0,i.k6)((()=>[(0,i.bF)(T,{src:q.getUserData[t.senderID]?q.getUserData[t.senderID].photo_url:"","spinner-size":"sm","spinner-color":"primary",style:{height:"48px","max-width":"48px","min-width":"48px"},fit:"cover",loading:"lazy"},null,8,["src"])])),_:2},1024)])),default:(0,i.k6)((()=>[t.message?((0,i.uX)(),(0,i.CE)("div",p,(0,a.v_)(t.message),1)):(0,i.Q3)("",!0),t.fileUrl?((0,i.uX)(),(0,i.Wv)(T,{key:1,src:t.fileUrl,"spinner-size":"sm","spinner-color":"primary",style:{"min-height":"150px","min-width":"150px","max-width":"150px"}},null,8,["src"])):(0,i.Q3)("",!0)])),_:2},1032,["name","avatar","stamp","text-color","bg-color","sent"])))),128)),((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(q.getUserTyping,((t,s)=>((0,i.uX)(),(0,i.CE)(i.FK,{key:t},[t?((0,i.uX)(),(0,i.CE)(i.FK,{key:0},[s!=U.user_uuid?((0,i.uX)(),(0,i.Wv)(M,{key:0,name:q.getUserData[s]?s==U.user_uuid?e.$t("You"):q.getUserData[s].first_name:"",avatar:q.getUserData[s]?q.getUserData[s].photo_url:"",stamp:t.time,"text-color":s==U.user_uuid?"white":"dark","bg-color":"amber",sent:s==U.user_uuid},{default:(0,i.k6)((()=>[(0,i.bF)(L,{size:"2rem"})])),_:2},1032,["name","avatar","stamp","text-color","sent"])):(0,i.Q3)("",!0)],64)):(0,i.Q3)("",!0)],64)))),128))])),_:1},512),q.hasConversation?((0,i.uX)(),(0,i.CE)("div",_,[(0,i.bF)(W,{url:U.chat_api_url,multiple:"",ref:"uploader",flat:"",accept:".jpg, image/*","max-total-size":"10485760","field-name":"file",onAdded:q.afterAddedFiles,onRemoved:q.afterRemoveFiles,onRejected:q.onRejectedFiles,onUploading:q.onUploadingFiles,onUploaded:q.afterUploaded,onFinish:q.afterFinishUpload,class:"full-width"},{header:(0,i.k6)((()=>[(0,i.bF)(O)])),list:(0,i.k6)((e=>[(0,i.Lk)("div",f,[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(e.files,(t=>((0,i.uX)(),(0,i.CE)("div",{key:t.__key,class:"relative-position"},[(0,i.Lk)("img",{src:t.__img.src,style:{"max-width":"60px",height:"60px"},class:"radius10"},null,8,y),(0,i.Lk)("div",b,[(0,i.bF)(w,{unelevated:"",round:"",color:"blue",icon:"close",size:"xs",onClick:s=>e.removeFile(t)},null,8,["onClick"])])])))),128))])])),_:1},8,["url","onAdded","onRemoved","onRejected","onUploading","onUploaded","onFinish"]),(0,i.bF)(H,{color:"blue",modelValue:U.message,"onUpdate:modelValue":t[0]||(t[0]=e=>U.message=e),label:e.$t("Your message"),ref:"message",autogrow:"",borderless:""},{append:(0,i.k6)((()=>[q.isMobile?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("div",k,[(0,i.bF)(w,{unelevated:"",round:"",color:e.$q.dark.mode?"grey600":"mygrey","text-color":e.$q.dark.mode?"grey300":"grey",onClick:q.pickFiles,dense:""},{default:(0,i.k6)((()=>[(0,i.bF)(z,{name:"attach_file",class:"rotate-45"})])),_:1},8,["color","text-color","onClick"]),(0,i.bF)(w,{unelevated:"",round:"",color:e.$q.dark.mode?"grey600":"mygrey","text-color":e.$q.dark.mode?"grey300":"grey",dense:""},{default:(0,i.k6)((()=>[(0,i.bF)(z,{name:"emoji_emotions"}),(0,i.bF)(B,{ref:"proxy"},{default:(0,i.k6)((()=>[(0,i.bF)(V,null,{default:(0,i.k6)((()=>[(0,i.bF)(R,{native:!0,onSelect:q.onSelectEmoji,"disable-skin-tones":!0},null,8,["onSelect"])])),_:1})])),_:1},512)])),_:1},8,["color","text-color"]),(0,i.bF)(w,{onClick:q.onSubmit,disabled:!q.hasMessage,flat:"",color:e.$q.dark.mode?"grey600":"primary","text-color":e.$q.dark.mode?"grey300":"grey",label:e.$t("Send"),"no-caps":"",size:"md"},null,8,["onClick","disabled","color","text-color","label"])]))])),_:1},8,["modelValue","label"]),q.isMobile?((0,i.uX)(),(0,i.CE)("div",v,[(0,i.Lk)("div",x,[(0,i.Lk)("div",F,[(0,i.bF)(w,{unelevated:"",round:"",color:e.$q.dark.mode?"grey600":"mygrey","text-color":e.$q.dark.mode?"grey300":"grey",onClick:q.pickFiles,dense:""},{default:(0,i.k6)((()=>[(0,i.bF)(z,{name:"attach_file",class:"rotate-45"})])),_:1},8,["color","text-color","onClick"]),(0,i.bF)(w,{unelevated:"",round:"",color:e.$q.dark.mode?"grey600":"mygrey","text-color":e.$q.dark.mode?"grey300":"grey",dense:""},{default:(0,i.k6)((()=>[(0,i.bF)(z,{name:"emoji_emotions"}),(0,i.bF)(B,{ref:"proxy"},{default:(0,i.k6)((()=>[(0,i.bF)(V,null,{default:(0,i.k6)((()=>[(0,i.bF)(R,{native:!0,onSelect:q.onSelectEmoji,"disable-skin-tones":!0},null,8,["onSelect"])])),_:1})])),_:1},512)])),_:1},8,["color","text-color"])]),(0,i.Lk)("div",C,[(0,i.bF)(w,{onClick:q.onSubmit,disabled:!q.hasMessage,flat:"",color:e.$q.dark.mode?"grey600":"primary","text-color":e.$q.dark.mode?"grey300":"grey",label:e.$t("Send"),"no-caps":"",size:"md"},null,8,["onClick","disabled","color","text-color","label"])])])])):(0,i.Q3)("",!0)])):(0,i.Q3)("",!0)])])),_:1})])])])])])),_:1})}s(7781),s(4739),s(9526);var U=s(2911),q=s(3414),A=s(8336),$=s(4955),E=s(6188),w=s(8815),Q=s(546),I=s(9818),S=s(9862);const{getScrollTarget:X,setVerticalScrollPosition:j}=A.Ay,T={name:"ChatConversation",components:{LocationNav:(0,i.$V)((()=>Promise.all([s.e(4121),s.e(996),s.e(7691)]).then(s.bind(s,5897)))),AccountNav:(0,i.$V)((()=>Promise.all([s.e(4121),s.e(996)]).then(s.bind(s,8275)))),AddressesSkeleton:(0,i.$V)((()=>Promise.all([s.e(4121),s.e(996)]).then(s.bind(s,2171)))),StickyBack:(0,i.$V)((()=>Promise.all([s.e(4121),s.e(996)]).then(s.bind(s,7763)))),EmojiPicker:$.A},data(){return{message:"",loading:!1,conversation_id:"",data:[],user_typing_data:[],chating_with_user_uuid:"",user_uuid:"",user_data:[],participants:[],main_user_type:"",loading_user:!0,is_typing:!1,files:{},file_url:"",file_type:"",upload_loading:!1,chat_api_url:q.A.api_base_url+"/chatapi/uploadimage",participant_user_uuid:"",order_id:""}},mounted(){this.conversation_id=this.$route.query.doc_id;let e=I.A.getUser();this.user_uuid=e.client_uuid,this.getMessages(),this.getParticipant(),this.getWhoIsTyping(),this.getDocumentDetails()},computed:{isMobile(){return!!this.$q.screen.lt.md},getChatmessage(){return this.data},hasMessageOld(){return Object.keys(this.data).length>0},hasMessage(){return!U.A.empty(this.message)||Object.keys(this.files).length>0},hasChatDocID(){return!empty(this.chating_with_user_uuid)},hasUserData(){return Object.keys(this.user_data).length>0},getUserData(){return this.user_data},getUserTyping(){return this.user_typing_data},hasConversation(){return!U.A.empty(this.conversation_id)}},watch:{is_typing(e,t){e?this.UpdateWhoistyping(!0):this.UpdateWhoistyping(!1)},message(e,t){this.is_typing||setTimeout((()=>{this.is_typing=!1}),1e3),this.is_typing=!0}},methods:{scrollTobottom(){setTimeout((()=>{if("undefined"!==typeof this.$refs.scroll_ref&&null!==this.$refs.scroll_ref){let e=parseInt(this.$refs.scroll_ref.getScroll().verticalSize)+100;this.$refs.scroll_ref.setScrollPosition("vertical",e)}}),500)},onSelectEmoji(e){(0,E.A)(document.querySelector("textarea"),e.i),this.$refs.proxy.hide()},getMessages(){this.loading=!0;const e=(0,Q.H9)(w.firebaseDb,w.firebaseCollectionEnum.chats,this.conversation_id),t=(0,Q.P)((0,Q.rJ)(e,"messages"),(0,Q.My)("timestamp","asc"),(0,Q.AB)(w.firebaseCollectionEnum.limit));(0,Q.aQ)(t,(e=>{this.data=[],this.loading=!1,e.forEach((e=>{if(e.exists()){const t=e.data();let s=t.timestamp.toDate().toISOString();this.data.push({fileType:t.fileType,fileUrl:t.fileUrl,message:t.message,senderID:t.senderID,timestamp:s,time:S.Ay.formatDate(s,"hh:mm a")})}else console.log("Conversation document does not exist")})),this.scrollTobottom()}),(e=>{this.loading=!1,console.error("Error fetching messages:",e)}))},getWhoIsTyping(){const e=(0,Q.H9)(w.firebaseDb,w.firebaseCollectionEnum.chats,this.conversation_id);(0,Q.aQ)(e,(e=>{if(e.exists()){let t=e.data();this.user_typing_data=t.isTyping||[],Object.entries(this.user_typing_data).forEach((([e,t])=>{t&&e!=this.user_uuid&&this.scrollTobottom()}))}else this.user_typing_data=[]}),(e=>{console.error("Error fetching chat document:",e)}))},async getParticipant(){try{const e=(0,Q.H9)(w.firebaseDb,w.firebaseCollectionEnum.chats,this.conversation_id),t=await(0,Q.x7)(e);if(t.exists()){this.participants=t.data().participants;let e=this.participants.filter((e=>!e.includes(this.user_uuid)));this.participant_user_uuid=e[0]?e[0]:null,this.getUser()}else console.log("Conversation document does not exist")}catch(e){console.error("Error getting participants:",e)}},getUser(){this.loading_user=!0,U.A.fetchDataChats("getUsers",{main_user_type:this.main_user_type,users:this.participants}).then((e=>{this.user_data=e.details})).catch((e=>{this.user_data=[]})).then((e=>{this.loading_user=!1}))},async UpdateWhoistyping(e){try{const t=(0,Q.H9)(w.firebaseDb,w.firebaseCollectionEnum.chats,this.conversation_id);await(0,Q.mZ)(t,{[`isTyping.${this.user_uuid}`]:e})}catch(e){console.error("Error updating typing status:",e)}},onSubmit(){Object.keys(this.files).length>0?this.$refs.uploader.upload():this.saveChatMessage()},async saveChatMessage(){this.loading=!0;const e=(0,Q.rJ)(w.firebaseDb,w.firebaseCollectionEnum.chats,this.conversation_id,"messages");try{await(0,Q.gS)(e,{message:this.message,senderID:this.user_uuid,timestamp:Q.Dc.now(),serverTimestamp:(0,Q.O5)(),fileUrl:this.file_url,fileType:this.file_type}),this.loading=!1,this.documentLastUpdate(this.conversation_id),this.resetChat(),this.notifyUser()}catch(e){console.error("Error adding message to the conversation:",e),U.A.notify("dark",e,"error",this.$q)}},async documentLastUpdate(e){try{const t=(0,Q.H9)(w.firebaseDb,w.firebaseCollectionEnum.chats,e);await(0,Q.mZ)(t,{lastUpdated:(0,Q.O5)()})}catch(e){U.A.notify("dark",e,"error",this.$q)}},resetChat(){this.message="",this.file_url="",this.file_type="",this.files={},this.$refs.uploader.reset()},pickFiles(){this.$refs.uploader.pickFiles()},onRejectedFiles(e){U.A.notify("dark",this.$t("Invalid file type"),"error",this.$q)},afterAddedFiles(e){Object.entries(e).forEach((([e,t])=>{this.files[t.name]={name:t.name}}))},afterRemoveFiles(e){Object.entries(e).forEach((([e,t])=>{delete this.files[t.name]}))},onUploadingFiles(e){this.upload_loading=!0},afterUploaded(e){if(200==e.xhr.status){let t=JSON.parse(e.xhr.response),s=t.code||!1,i=t.details||[],a=t.msg||"";1==s?(this.file_url=i.file_url,this.file_type=i.file_type,this.saveChatMessage()):(U.A.notify("dark",a,"error",this.$q),this.$refs.uploader.reset())}else U.A.notify("dark",this.$t("IError uploading files"),"error",this.$q),this.$refs.uploader.reset()},afterFinishUpload(){this.upload_loading=!1},notifyUser(){U.A.fetchDataChats("notifyUser",{from_user_uuid:this.user_uuid,user_uuid:this.participant_user_uuid}).then((e=>{})).catch((e=>{})).then((e=>{}))},async getDocumentDetails(){const e=(0,Q.H9)(w.firebaseDb,w.firebaseCollectionEnum.chats,this.conversation_id),t=await(0,Q.x7)(e);t.exists()?this.order_id=t.data().orderID:this.order_id=""}}};var M=s(2807),L=s(7716),P=s(3316),O=s(124),W=s(5173),z=s(6384),R=s(3952),V=s(386),B=s(8958),H=s(9035),K=s(1770),N=s(2665),J=s(9198),Y=s(2415),Z=s(9101),G=s(9270),ee=s(492),te=s(1356),se=s(8582),ie=s.n(se);const ae=(0,M.A)(T,[["render",D]]),re=ae;ie()(T,"components",{QPage:L.A,QCard:P.A,QItem:O.A,QItemSection:W.A,QBtn:z.A,QAvatar:R.A,QSeparator:V.A,QScrollArea:B.A,QInnerLoading:H.A,QChatMessage:K.A,QImg:N.A,QSpinnerDots:J.A,QUploader:Y.A,QUploaderAddTrigger:Z.A,QInput:G.A,QIcon:ee.A,QPopupProxy:te.A})}}]);