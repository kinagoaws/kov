"use strict";(globalThis["webpackChunkcom_kinago_single"]=globalThis["webpackChunkcom_kinago_single"]||[]).push([[7761],{7761:(t,e,a)=>{a.r(e),a.d(e,{default:()=>P});var s=a(1758),i=a(8790);const r={class:"row justify-center q-pa-md"},n={class:"col-md-9 col-12"},l={class:"row"},o={key:0,class:"col-md-4 col-sm-4 col-xs-12"},u={class:"col-md-8 col-sm-8 col-xs-12"},c={class:"text-weight-bold"},d={key:0,class:"text-body2 text-weight-medium flex flex-center text-grey",style:{height:"calc(35vh)"}},h={class:"q-pt-md",style:{"min-height":"calc(60vh)"}},g=["src"],_={key:0,class:"text-primary"},p={key:0,class:"time"};function y(t,e,a,y,b,m){const k=(0,s.g2)("StickyBack"),f=(0,s.g2)("LocationNav"),v=(0,s.g2)("AccountNav"),C=(0,s.g2)("q-item-label"),A=(0,s.g2)("q-item-section"),F=(0,s.g2)("q-btn"),E=(0,s.g2)("q-item"),D=(0,s.g2)("q-separator"),w=(0,s.g2)("q-inner-loading"),L=(0,s.g2)("q-skeleton"),Q=(0,s.g2)("q-list"),$=(0,s.g2)("q-avatar"),S=(0,s.g2)("q-card"),q=(0,s.g2)("q-page");return(0,s.uX)(),(0,s.Wv)(q,{padding:""},{default:(0,s.k6)((()=>[m.isMobile?((0,s.uX)(),(0,s.Wv)(k,{key:0,url:"/account/menu",label:"Back"})):((0,s.uX)(),(0,s.Wv)(f,{key:1})),(0,s.Lk)("div",r,[(0,s.Lk)("div",n,[(0,s.Lk)("div",l,[m.isMobile?(0,s.Q3)("",!0):((0,s.uX)(),(0,s.CE)("div",o,[(0,s.bF)(v)])),(0,s.Lk)("div",u,[(0,s.bF)(S,{flat:"",class:"fit"},{default:(0,s.k6)((()=>[(0,s.bF)(E,null,{default:(0,s.k6)((()=>[(0,s.bF)(A,null,{default:(0,s.k6)((()=>[(0,s.bF)(C,{class:"text-weight-bold"},{default:(0,s.k6)((()=>[(0,s.Lk)("h5",c,(0,i.v_)(t.$t("Live Chat")),1)])),_:1}),(0,s.bF)(C,{caption:""},{default:(0,s.k6)((()=>[(0,s.eW)((0,i.v_)(t.$t("Let's chat and chase the blues")),1)])),_:1})])),_:1}),(0,s.bF)(A,{side:""},{default:(0,s.k6)((()=>[(0,s.bF)(F,{round:"",color:"blue",icon:"chat",onClick:e[0]||(e[0]=t=>m.searchConversation(y.SettingsStore.merchant_uuid))})])),_:1})])),_:1}),(0,s.bF)(D),(0,s.bF)(w,{color:"warning",showing:b.loading_searchat},null,8,["showing"]),m.hasData||b.loading?(0,s.Q3)("",!0):((0,s.uX)(),(0,s.CE)("div",d,(0,i.v_)(t.$t("Click chat button to start to chat with restaurant")),1)),(0,s.Lk)("div",h,[b.loading?((0,s.uX)(),(0,s.Wv)(Q,{key:0},{default:(0,s.k6)((()=>[((0,s.uX)(),(0,s.CE)(s.FK,null,(0,s.pI)(6,(t=>(0,s.bF)(E,{key:t},{default:(0,s.k6)((()=>[(0,s.bF)(A,{avatar:""},{default:(0,s.k6)((()=>[(0,s.bF)(L,{type:"QAvatar"})])),_:1}),(0,s.bF)(A,null,{default:(0,s.k6)((()=>[(0,s.bF)(C,null,{default:(0,s.k6)((()=>[(0,s.bF)(L,{type:"text"})])),_:1}),(0,s.bF)(C,{caption:""},{default:(0,s.k6)((()=>[(0,s.bF)(L,{type:"text"})])),_:1})])),_:1})])),_:2},1024))),64))])),_:1})):(0,s.Q3)("",!0),m.hasData&&!b.loading&&m.hasUserData?((0,s.uX)(),(0,s.Wv)(Q,{key:1},{default:(0,s.k6)((()=>[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(m.getData,(e=>((0,s.uX)(),(0,s.CE)(s.FK,{key:e},[b.users_data[e.user_uuid]?((0,s.uX)(),(0,s.Wv)(E,{key:0,clickable:"",onClick:t=>m.loadConversation(e.doc_id)},{default:(0,s.k6)((()=>[(0,s.bF)(A,{avatar:""},{default:(0,s.k6)((()=>[(0,s.bF)($,null,{default:(0,s.k6)((()=>[(0,s.Lk)("img",{src:b.users_data[e.user_uuid].photo_url},null,8,g)])),_:2},1024)])),_:2},1024),(0,s.bF)(A,null,{default:(0,s.k6)((()=>[(0,s.bF)(C,{class:"text-weight-bold"},{default:(0,s.k6)((()=>[(0,s.eW)((0,i.v_)(b.users_data[e.user_uuid].first_name)+" "+(0,i.v_)(b.users_data[e.user_uuid].last_name),1)])),_:2},1024),(0,s.bF)(C,{caption:""},{default:(0,s.k6)((()=>[e.orderID?((0,s.uX)(),(0,s.CE)(s.FK,{key:0},[(0,s.eW)((0,i.v_)(t.$t("Order#"))+" "+(0,i.v_)(e.orderID),1)],64)):((0,s.uX)(),(0,s.CE)(s.FK,{key:1},[(0,s.eW)((0,i.v_)(b.users_data[e.user_uuid].user_type),1)],64))])),_:2},1024),m.getLastMessageData[e.doc_id]?((0,s.uX)(),(0,s.Wv)(C,{key:0,caption:"",lines:"2"},{default:(0,s.k6)((()=>[m.isTyping(e.user_uuid)?((0,s.uX)(),(0,s.CE)("span",_,(0,i.v_)(b.users_data[e.user_uuid].first_name)+" is typing ...",1)):((0,s.uX)(),(0,s.CE)(s.FK,{key:1},[(0,s.eW)((0,i.v_)(m.getLastMessageData[e.doc_id].message),1)],64))])),_:2},1024)):(0,s.Q3)("",!0)])),_:2},1024),(0,s.bF)(A,{side:""},{default:(0,s.k6)((()=>[(0,s.bF)(C,{caption:"",lines:"2",class:"text-center"},{default:(0,s.k6)((()=>[m.getLastMessageData[e.doc_id]?((0,s.uX)(),(0,s.CE)("div",p,(0,i.v_)(m.getLastMessageData[e.doc_id].time),1)):(0,s.Q3)("",!0)])),_:2},1024)])),_:2},1024)])),_:2},1032,["onClick"])):(0,s.Q3)("",!0)],64)))),128))])),_:1})):(0,s.Q3)("",!0)])])),_:1})])])])])])),_:1})}a(7781),a(4739),a(9526);var b=a(2911),m=a(8815),k=a(546),f=a(9818),v=a(9862),C=a(2302);const A={name:"ChatPage",components:{LocationNav:(0,s.$V)((()=>Promise.all([a.e(4121),a.e(996),a.e(2929)]).then(a.bind(a,5897)))),AccountNav:(0,s.$V)((()=>a.e(996).then(a.bind(a,8275)))),AddressesSkeleton:(0,s.$V)((()=>Promise.all([a.e(4121),a.e(996)]).then(a.bind(a,2171)))),StickyBack:(0,s.$V)((()=>Promise.all([a.e(4121),a.e(996)]).then(a.bind(a,7763))))},data(){return{user_uuid:"",data:[],users:[],all_users:[],users_data:[],loading:!0,loading_user:!1,last_message_data:{},whoistyping_data:{},document_id:"",main_user_type:"",refresh_page:void 0,loading_searchat:!1}},setup(t){const e=(0,C.C)();return{SettingsStore:e}},computed:{isMobile(){return!!this.$q.screen.lt.md},getData(){return this.data},getLastMessageData(){return this.last_message_data},hasData(){return Object.keys(this.data).length>0},hasUserData(){return Object.keys(this.users_data).length>0},getShowistyping(){return this.whoistyping_data}},async mounted(){let t=f.A.getUser();this.user_uuid=t.client_uuid,b.A.empty(this.user_uuid)?this.$router.push("/home"):Object.keys(this.SettingsStore.settings_data).length>0?this.SettingsStore.settings_data.chat_enabled?this.getParticipants():this.$router.push("/home"):this.$watch((()=>this.SettingsStore.$state.settings_data),((t,e)=>{t.chat_enabled?this.getParticipants():this.$router.push("/home")}))},methods:{getParticipants(){try{this.loading=!0;const t=(0,k.rJ)(m.firebaseDb,m.firebaseCollectionEnum.chats),e=(0,k.P)(t,(0,k._M)("participants","array-contains",this.user_uuid),(0,k.My)("lastUpdated","desc"),(0,k.AB)(m.firebaseCollectionEnum.limit));(0,k.aQ)(e,(t=>{this.data=[],this.users=[],this.all_users=[],this.loading=!1,b.A.empty(this.refresh_page)||this.refresh_page(),t.forEach((t=>{let e=t.data(),a=e.isTyping||null,s=e.participants||null;if(s){Object.keys(s).length>0&&Object.entries(s).forEach((([t,e])=>{this.all_users.push(e)}));let i=s.filter((t=>!t.includes(this.user_uuid))),r=i[0]?i[0]:null;this.users.push(r),this.data.push({doc_id:t.id,user_uuid:r,is_typing:!!a[i[0]]&&a[i[0]],orderID:e.orderID||null,orderUuid:e.orderUuid||null})}})),Object.keys(this.users).length>0&&(this.getUser(),this.getLastMessage(),this.getWhoIsTyping())}),(t=>{this.loading=!1,b.A.empty(this.refresh_page)||this.refresh_page(),console.log("Error fetching chat documents:",t)}))}catch(t){b.A.notify("dark",t,"error",this.$q)}},getUser(){this.loading_user=!0,b.A.fetchDataChats("getUsers",{main_user_type:this.main_user_type,users:this.users}).then((t=>{this.users_data=t.details})).catch((t=>{this.users_data=[]})).then((t=>{this.loading_user=!1}))},async getLastMessage(){try{if(Object.keys(this.all_users).length>0){const t=this.all_users.splice(0,10),e=(0,k.rJ)(m.firebaseDb,m.firebaseCollectionEnum.chats),a=await(0,k.GG)((0,k.P)(e,(0,k._M)("participants","array-contains-any",t)));a.forEach((async e=>{const a=e.id,s=(0,k.rJ)(m.firebaseDb,m.firebaseCollectionEnum.chats,a,"messages"),i=await(0,k.GG)((0,k.P)(s,(0,k._M)("senderID","in",t),(0,k.My)("timestamp","desc"),(0,k.AB)(1)));i.forEach((t=>{let e=t.data(),s=e.timestamp.toDate().toISOString();this.last_message_data[a]={message:e.message,timestamp:s,time:v.Ay.formatDate(s,"hh:mm a")}}))}))}}catch(t){console.error("Error fetching last message:",t)}},async getWhoIsTyping(){if(Object.keys(this.users).length>0){const t=this.users.splice(0,10),e=(0,k.P)((0,k.rJ)(m.firebaseDb,m.firebaseCollectionEnum.chats),(0,k._M)("participants","array-contains-any",t),(0,k.My)("lastUpdated","desc"),(0,k.AB)(m.firebaseCollectionEnum.limit));(0,k.aQ)(e,(t=>{t.forEach((t=>{let e=t.data(),a=e.isTyping||[];Object.keys(a).length>0&&Object.entries(a).forEach((([t,e])=>{this.whoistyping_data[t]=e}))}))}))}},isTyping(t){if(Object.keys(this.whoistyping_data).length>0){let e=this.whoistyping_data[t]||!1;return e}return!1},async searchConversation(t){try{this.loading_searchat=!0;const e=(0,k.rJ)(m.firebaseDb,m.firebaseCollectionEnum.chats),a=(0,k.P)(e,(0,k._M)("participants","array-contains",t),(0,k.My)("lastUpdated","desc"),(0,k.AB)(1));let s="";const i=await(0,k.GG)(a);i.forEach((t=>{let e=t.data(),a=e.participants||null;!0===a.includes(this.user_uuid)&&(s=t.id)})),b.A.empty(s)?this.createConversation(t):(this.loading_searchat=!1,this.loadConversation(s))}catch(t){b.A.notify("dark",t,"error",this.$q)}},async createConversation(t){try{const e=await(0,k.gS)((0,k.rJ)(m.firebaseDb,m.firebaseCollectionEnum.chats),{lastUpdated:(0,k.O5)()}),a=e.id,s=(0,k.H9)(m.firebaseDb,m.firebaseCollectionEnum.chats,a);let i=this.user_uuid,r={lastUpdated:(0,k.O5)(),dateCreated:(0,k.O5)(),participants:[t,i],isTyping:{[`${t}`]:!1,[`${i}`]:!1}};(0,k.BN)(s,r).then((()=>{this.loading_searchat=!1,this.loadConversation(a)})).catch((t=>{b.A.notify("dark",t,"error",this.$q)}))}catch(t){b.A.notify("dark",t,"error",this.$q)}},loadConversation(t){this.$router.push({path:"/account/chat/conversation",query:{doc_id:t}})}}};var F=a(2807),E=a(7716),D=a(3316),w=a(124),L=a(5173),Q=a(3796),$=a(6384),S=a(386),q=a(9035),M=a(3999),X=a(3820),O=a(3952),x=a(8582),I=a.n(x);const W=(0,F.A)(A,[["render",y]]),P=W;I()(A,"components",{QPage:E.A,QCard:D.A,QItem:w.A,QItemSection:L.A,QItemLabel:Q.A,QBtn:$.A,QSeparator:S.A,QInnerLoading:q.A,QList:M.A,QSkeleton:X.Ay,QAvatar:O.A})}}]);