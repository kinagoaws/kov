import{_ as B,U as N,ae as V,X as h,m as l,Y as c,f as a,p as s,af as A,F as y,Q as j,bh as F,bg as W,$ as x,a0 as m,P as U,R as d,S as D,ac as b,n as Q,Z as P,a1 as z}from"./index.c5b868f5.js";import{Q as H}from"./QToolbar.9b15bf0e.js";import{Q as X}from"./QHeader.b374650f.js";import{Q as p}from"./QItemLabel.4665782c.js";import{Q as Y}from"./QInnerLoading.ff23f6a9.js";import{Q as L}from"./QSkeleton.11b8074a.js";import{Q as R}from"./QList.9b7158f1.js";import{Q as Z}from"./QPage.528ab8a8.js";import{c as S,f as k,b as g,q as w,w as C,o as q,l as I,h as M,g as E,e as G,s as O,d as J,a as K}from"./FirebaseChat.017a0d5e.js";import{d as tt}from"./date.01ece05d.js";import"./QResizeObserver.3ed5059f.js";import"./format.8ac60962.js";const et={name:"ChatPage",data(){return{user_uuid:"",data:[],users:[],all_users:[],users_data:[],loading:!0,loading_user:!1,last_message_data:{},whoistyping_data:{},document_id:"",main_user_type:"",refresh_page:void 0,loading_searchat:!1}},setup(t){return{SettingStore:N()}},async mounted(){let t=V.getUser();this.user_uuid=t.client_uuid,h.empty(this.user_uuid)?this.$router.push("/home"):Object.keys(this.SettingStore.settings_data).length>0?this.SettingStore.settings_data.chat_enabled?this.getParticipants():this.$router.push("/home"):this.$watch(()=>this.SettingStore.$state.settings_data,(n,u)=>{n.chat_enabled?this.getParticipants():this.$router.push("/home")})},computed:{getData(){return this.data},getLastMessageData(){return this.last_message_data},hasData(){return Object.keys(this.data).length>0},hasUserData(){return Object.keys(this.users_data).length>0},getShowistyping(){return this.whoistyping_data}},methods:{getParticipants(){try{this.loading=!0;const t=S(k,g.chats),n=w(t,C("participants","array-contains",this.user_uuid),q("lastUpdated","desc"),I(g.limit)),u=M(n,o=>{this.data=[],this.users=[],this.all_users=[],this.loading=!1,h.empty(this.refresh_page)||this.refresh_page(),o.forEach(i=>{let r=i.data(),e=r.isTyping||null,_=r.participants||null;if(_){Object.keys(_).length>0&&Object.entries(_).forEach(([T,$])=>{this.all_users.push($)});let f=_.filter(T=>!T.includes(this.user_uuid)),v=f[0]?f[0]:null;this.users.push(v),this.data.push({doc_id:i.id,user_uuid:v,is_typing:e[f[0]]?e[f[0]]:!1,orderID:r.orderID||null,orderUuid:r.orderUuid||null})}}),Object.keys(this.users).length>0&&(this.getUser(),this.getLastMessage(),this.getWhoIsTyping())},o=>{this.loading=!1,h.empty(this.refresh_page)||this.refresh_page(),console.log("Error fetching chat documents:",o)})}catch(t){h.notify("dark",t,"error",this.$q)}},getUser(){this.loading_user=!0,h.fetchDataChats("getUsers",{main_user_type:this.main_user_type,users:this.users}).then(t=>{this.users_data=t.details}).catch(t=>{this.users_data=[]}).then(t=>{this.loading_user=!1})},async getLastMessage(){try{const t=this.all_users.splice(0,10),n=S(k,g.chats);(await E(w(n,C("participants","array-contains-any",this.users)))).forEach(async o=>{const i=o.id,r=S(k,g.chats,i,"messages");(await E(w(r,C("senderID","in",t),q("timestamp","desc"),I(1)))).forEach(_=>{let f=_.data(),v=f.timestamp.toDate().toISOString();this.last_message_data[i]={message:f.message,timestamp:v,time:tt.formatDate(v,"hh:mm a")}})})}catch(t){console.error("Error fetching last message:",t)}},async getWhoIsTyping(){const t=w(S(k,g.chats),C("participants","array-contains-any",this.users),q("lastUpdated","desc"),I(g.limit));M(t,n=>{n.forEach(u=>{let i=u.data().isTyping||[];Object.keys(i).length>0&&Object.entries(i).forEach(([r,e])=>{this.whoistyping_data[r]=e})})})},isTyping(t){return Object.keys(this.whoistyping_data).length>0&&this.whoistyping_data[t]||!1},async searchConversation(t){try{this.loading_searchat=!0;const n=S(k,g.chats),u=w(n,C("participants","array-contains",t),q("lastUpdated","desc"),I(1));let o="";(await E(u)).forEach(r=>{(r.data().participants||null).includes(this.user_uuid)===!0&&(o=r.id)}),h.empty(o)?this.createConversation(t):(this.loading_searchat=!1,this.loadConversation(o))}catch(n){h.notify("dark",n,"error",this.$q)}},async createConversation(t){try{const u=(await G(S(k,g.chats),{lastUpdated:O()})).id,o=J(k,g.chats,u);let i=this.user_uuid,r={lastUpdated:O(),dateCreated:O(),participants:[t,i],isTyping:{[`${t}`]:!1,[`${i}`]:!1}};K(o,r).then(()=>{this.loading_searchat=!1,this.loadConversation(u)}).catch(e=>{h.notify("dark",e,"error",this.$q)})}catch(n){h.notify("dark",n,"error",this.$q)}},loadConversation(t){this.$router.push({path:"/account/chat/conversation",query:{doc_id:t}})}}},at={class:"text-weight-bold text-body1"},st={key:0,class:"text-body2 text-weight-medium flex flex-center text-grey text-center card-small-medium"},rt={class:"q-pt-md card-form"},it=["src"],nt={key:0,class:"text-primary"},ot={key:0,class:"time"};function lt(t,n,u,o,i,r){return l(),c(y,null,[a(X,{reveal:"",class:A({"bg-mydark text-white":t.$q.dark.mode,"bg-white text-dark":!t.$q.dark.mode})},{default:s(()=>[a(H,null,{default:s(()=>[a(j,{onClick:n[0]||(n[0]=e=>t.$router.back()),round:"",dense:"",icon:"arrow_back",unelevated:"",color:t.$q.dark.mode?"grey":"mygrey","text-color":t.$q.dark.mode?"grey-9":"dark"},null,8,["color","text-color"])]),_:1})]),_:1},8,["class"]),a(Z,null,{default:s(()=>[a(F,{flat:""},{default:s(()=>[a(W,{class:"q-pt-none q-pb-none"},{default:s(()=>[a(x,null,{default:s(()=>[a(m,null,{default:s(()=>[a(p,{class:"text-weight-bold"},{default:s(()=>[U("div",at,d(t.$t("Live Chat")),1)]),_:1}),a(p,{caption:""},{default:s(()=>[D(d(t.$t("Let's chat and chase the blues")),1)]),_:1})]),_:1}),a(m,{side:""},{default:s(()=>[a(j,{round:"",color:"blue",icon:"chat",onClick:n[1]||(n[1]=e=>r.searchConversation(o.SettingStore.merchant_uuid))})]),_:1})]),_:1}),a(Y,{color:"warning",showing:i.loading_searchat},null,8,["showing"]),!r.hasData&&!i.loading?(l(),c("div",st,d(t.$t("Click chat button to start to chat with restaurant")),1)):b("",!0),U("div",rt,[i.loading?(l(),Q(R,{key:0},{default:s(()=>[(l(),c(y,null,P(6,e=>a(x,{key:e},{default:s(()=>[a(m,{avatar:""},{default:s(()=>[a(L,{type:"QAvatar"})]),_:1}),a(m,null,{default:s(()=>[a(p,null,{default:s(()=>[a(L,{type:"text"})]),_:1}),a(p,{caption:""},{default:s(()=>[a(L,{type:"text"})]),_:1})]),_:1})]),_:2},1024)),64))]),_:1})):b("",!0),r.hasData&&!i.loading&&r.hasUserData?(l(),Q(R,{key:1,separator:""},{default:s(()=>[(l(!0),c(y,null,P(r.getData,e=>(l(),c(y,{key:e},[i.users_data[e.user_uuid]?(l(),Q(x,{key:0,clickable:"",onClick:_=>r.loadConversation(e.doc_id)},{default:s(()=>[a(m,{avatar:""},{default:s(()=>[a(z,null,{default:s(()=>[U("img",{src:i.users_data[e.user_uuid].photo_url},null,8,it)]),_:2},1024)]),_:2},1024),a(m,null,{default:s(()=>[a(p,{class:"text-weight-bold"},{default:s(()=>[D(d(i.users_data[e.user_uuid].first_name)+" "+d(i.users_data[e.user_uuid].last_name),1)]),_:2},1024),a(p,{caption:""},{default:s(()=>[e.orderID?(l(),c(y,{key:0},[D(d(t.$t("Order#"))+" "+d(e.orderID),1)],64)):(l(),c(y,{key:1},[D(d(i.users_data[e.user_uuid].user_type),1)],64))]),_:2},1024),r.getLastMessageData[e.doc_id]?(l(),Q(p,{key:0,caption:"",lines:"2"},{default:s(()=>[r.isTyping(e.user_uuid)?(l(),c("span",nt,d(i.users_data[e.user_uuid].first_name)+" is typing ...",1)):(l(),c(y,{key:1},[D(d(r.getLastMessageData[e.doc_id].message),1)],64))]),_:2},1024)):b("",!0)]),_:2},1024),a(m,{side:""},{default:s(()=>[a(p,{caption:"",lines:"2",class:"text-center"},{default:s(()=>[r.getLastMessageData[e.doc_id]?(l(),c("div",ot,d(r.getLastMessageData[e.doc_id].time),1)):b("",!0)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"])):b("",!0)],64))),128))]),_:1})):b("",!0)])]),_:1})]),_:1})]),_:1})],64)}var St=B(et,[["render",lt]]);export{St as default};
