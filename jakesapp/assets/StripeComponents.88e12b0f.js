import{Q as u}from"./QSpace.24950ca6.js";import{_ as y,X as i,m as f,n as b,p as o,f as s,bh as g,af as c,bg as m,P as l,R as p,b8 as S,Q as _,ag as w,bd as C,bT as v,aX as $}from"./index.c5b868f5.js";import{Q as q}from"./QForm.997d74f6.js";import{C as P}from"./ClosePopup.32eeb9ff.js";const k={name:"StripeComponents",props:["title","label","payment_code","payment_credentials"],data(){return{show_modal:!1,data:[],loading:!1,visible:!1,client_secret:"",customer_id:"",publish_key:"",stripe:void 0,cardElement:void 0,cardholder_name:"",merchant_id:"",merchant_type:""}},methods:{beforeShow(){this.cardholder_name=""},showPaymentForm(){this.show_modal=!0,this.createCustomer()},close(){this.show_modal=!1},createCustomer(){typeof this.payment_credentials[this.payment_code]!="undefined"&&this.payment_credentials[this.payment_code]!==null&&(this.merchant_id=this.payment_credentials[this.payment_code].merchant_id,this.merchant_type=this.payment_credentials[this.payment_code].merchant_type);const t={merchant_id:this.merchant_id,payment_code:this.payment_code,merchant_type:this.merchant_type,reference:""};this.loading=!0,this.visible=!0,i.PaymentPost("StripeCreateCustomer",t).then(e=>{this.client_secret=e.details.client_secret,this.customer_id=e.details.customer_id,this.initStripe()}).catch(e=>{i.notify("dark",e,"error_outline",this.$q)}).then(e=>{this.loading=!1,this.visible=!1})},initStripe(){window.Stripe==null?new Promise(t=>{const e=window.document,a="stripe-script",d=e.createElement("script");d.id=a,d.setAttribute("src","https://js.stripe.com/v3/"),e.head.appendChild(d),d.onload=()=>{t()}}).then(()=>{this.renderCard()}):this.renderCard()},renderCard(){const t={base:{color:"#32325d",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"#aab7c4"}},invalid:{color:"#fa755a",iconColor:"#fa755a"}};if(typeof this.payment_credentials[this.payment_code]!="undefined"&&this.payment_credentials[this.payment_code]!==null){this.publish_key=this.payment_credentials[this.payment_code].attr2,this.stripe=Stripe(this.publish_key);const e=this.stripe.elements();this.cardElement=e.create("card",{style:t}),setTimeout(()=>{this.cardElement.mount(this.$refs.card_element)},500)}else i.notify("dark","invalid payment credentials","warning",this.$q)},onSubmit(){this.loading=!0,this.visible=!0,this.stripe.confirmCardSetup(this.client_secret,{payment_method:{card:this.cardElement,billing_details:{name:this.cardholder_name}}}).then(t=>{this.loading=!1,this.visible=!1,t.error?t.error.code==="setup_intent_unexpected_state"?this.createIntent():i.notify("dark",JSON.stringify(t),"warning",this.$q):this.savePayment(t.setupIntent.payment_method)})},savePayment(t){this.loading=!0;const e={payment_method_id:t,merchant_id:this.merchant_id,payment_code:this.payment_code,merchant_type:this.merchant_type,reference:this.reference};i.PaymentPost("StripeSavePayment",e).then(a=>{this.close(),this.$emit("afterAddpayment")}).catch(a=>{i.notify("negative",a,"error_outline",this.$q)}).then(a=>{this.loading=!1})},createIntent(){const t={customer_id:this.customer_id,merchant_id:this.merchant_id,payment_code:this.payment_code,merchant_type:this.merchant_type};i.StripeCreateIntent(t).then(e=>{this.close(),this.$emit("afterAddpayment")}).catch(e=>{i.notify("negative",e,"error_outline",this.$q)}).then(e=>{this.loading=!1})},PaymentRender(t){const e={cart_uuid:t.cart_uuid,order_uuid:t.order_uuid,payment_uuid:t.payment_uuid,payment_code:t.payment_code};i.showLoadingBox(this.$t("processing_payment"),this.$q),i.PaymentPost("StripePaymentIntent",e).then(a=>{this.$emit("afterSuccessfulpayment",a.details)}).catch(a=>{i.notify("dark",a,"error_outline",this.$q)}).then(a=>{i.hideLoadingBox(this.$q)})},Dopayment(t){i.showLoadingBox(this.$t("processing_payment"),this.$q),i.PaymentPost("StripeProcesspayment",{data:t}).then(e=>{this.$emit("afterSuccessfulpayment",e.details)}).catch(e=>{i.notify("dark",e,"error",this.$q)}).then(e=>{i.hideLoadingBox(this.$q)})}}},Q={class:"text-h5 text-weight-bold"},x={class:"q-mb-md",ref:"card_element"},B={class:"font11"};function I(t,e,a,d,n,h){return f(),b($,{modelValue:n.show_modal,"onUpdate:modelValue":e[1]||(e[1]=r=>n.show_modal=r),persistent:"","transition-show":"scale","transition-hide":"scale",position:this.$q.screen.gt.sm?"standard":"bottom","full-width":!this.$q.screen.gt.sm,onBeforeShow:h.beforeShow},{default:o(()=>[s(g,{class:c({"bg-grey600 text-white":t.$q.dark.mode})},{default:o(()=>[s(m,{class:"row items-center q-pb-none"},{default:o(()=>[l("div",Q,p(a.title),1),s(u),S(s(_,{icon:"close",flat:"",round:"",dense:""},null,512),[[P]])]),_:1}),s(q,{onSubmit:h.onSubmit},{default:o(()=>[s(m,{class:c(["q-pa-md",{disabled:n.visible}])},{default:o(()=>[s(w,{color:"primary","stack-label":"",modelValue:n.cardholder_name,"onUpdate:modelValue":e[0]||(e[0]=r=>n.cardholder_name=r),rules:[r=>r&&r.length>0||"this field is required"],label:t.$t("Cardholder name")},null,8,["modelValue","rules","label"]),l("div",x,null,512),l("p",B,p(t.$t("authorise_financial"))+".",1)]),_:1},8,["class"]),s(C,{spaced:""}),s(v,null,{default:o(()=>[s(_,{type:"submit",unelevated:"",rounded:"",color:"primary","text-color":"white","no-caps":"",class:"full-width q-mb-sm",label:a.label.submit,size:"lg",loading:n.loading},null,8,["label","loading"])]),_:1})]),_:1},8,["onSubmit"])]),_:1},8,["class"])]),_:1},8,["modelValue","position","full-width","onBeforeShow"])}var L=y(k,[["render",I]]);export{L as default};
