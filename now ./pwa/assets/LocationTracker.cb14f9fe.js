import{u as S}from"./ScheduleStore.0e67fa88.js";import{u as w}from"./LocationStore.cd56c6b6.js";import{_ as L,b5 as v,bx as A,by as T,r as g,o as B,ag as p,X as i,bz as W,bL as x,q as D,Z as P,a0 as q,a1 as s,ae as h}from"./index.5da0f878.js";import{A as E,G as f}from"./AppLocation.7583bb97.js";import{u as G}from"./use-quasar.9ad85506.js";import{d as N,f as R,a as $,s as C}from"./firebase.ca0416b7.js";const m=v("BackgroundGeolocation"),F={name:"LocationTracker",setup(){const n=A();T();const c=G();S();const t=w(),r=g(void 0),a=g(void 0);B(()=>{a.value=p.getUser(),c.capacitor&&d()});function d(){E.islocationEnabled().then(e=>{c.capacitor&&(t.has_watcher||_(),b())}).catch(e=>{i.getSession("skip_location")!=1&&n.push({path:"/location/permission",query:{page:"/home"}})})}const _=()=>{m.addWatcher({backgroundMessage:"Location tracking updates.",backgroundTitle:"Tracking...",requestPermissions:!0,stale:!1,distanceFilter:2},(e,o)=>{o&&i.notify("red-5",o,"error_outline",c),t.coordinates={lat:e.latitude,lng:e.longitude,accuracy:e.accuracy,altitude:e.altitude,altitudeAccuracy:e.altitudeAccuracy,speed:e.speed,bearing:e.bearing,time:e.time,simulated:e.simulated,created_at:i.getDateTimeNow(),driver_id:a.value.driver_id},u(),l()}).then(e=>{t.has_watcher=!0,t.watchers.push(e)})};async function b(){console.log("watchLocation");let e=await f.getCurrentPosition();e&&(console.debug(e),t.coordinates={lat:e.coords.latitude,lng:e.coords.longitude,accuracy:e.coords.accuracy,altitude:e.coords.altitude,altitudeAccuracy:e.coords.altitudeAccuracy,speed:e.coords.speed,bearing:"",time:e.timestamp,simulated:!1,created_at:i.getDateTimeNow(),driver_id:a.value.driver_id},u(),l())}const y=()=>{f.clearWatch({id:r.value}).then(e=>{console.log("result of clear is",e)}).catch(e=>{console.log("clearWatch error",e)})},k=()=>{Object.keys(t.watchers).length>0&&Object.entries(t.watchers).forEach(([e,o])=>{m.removeWatcher({id:o}),t.watchers=[],t.has_watcher=!1})},u=async()=>{try{const e={url:W.api_base_url+"/updateLocation",headers:{Authorization:"token "+p.getToken()},params:{latitude:String(t.coordinates.lat),longitude:String(t.coordinates.lng),accuracy:String(t.coordinates.accuracy),altitude:String(t.coordinates.altitude),altitudeAccuracy:String(t.coordinates.altitudeAccuracy),speed:String(t.coordinates.speed),bearing:String(t.coordinates.bearing),time:String(t.coordinates.time),simulated:String(t.coordinates.simulated)}};let o=await x.get(e)}catch(e){console.log(e)}},l=async()=>{console.debug("setFirebaseLocation"),console.debug(a.value);const e=N($,R.driver,a.value.driver_uuid);await C(e,t.coordinates)};return{clearWatch:y,stopWacthers:k,LocationStore:t}}},I={class:"hidden"};function j(n,c,t,r,a,d){return D(),P("div",I,[q(" =>"+s(r.LocationStore.has_watcher)+" ",1),h("pre",null,s(r.LocationStore.watchers),1),h("pre",null,s(r.LocationStore.coordinates),1)])}var U=L(F,[["render",j]]);export{U as default};
